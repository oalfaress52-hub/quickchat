<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Quickchat II — Server</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="style.css" />
</head>
<body>

<div class="server-header">
  <h1>Quickchat II — Server</h1>
  <p id="serverInfo">Server: The Main Server</p>
</div>

<div class="server-layout">

  <!-- ===================== -->
  <!-- Chat Section -->
  <!-- ===================== -->
  <div class="chat-section">
    <div class="chat-container" id="chatContainer"></div>

    <div class="chat-input-container">
      <input type="text" id="chatInput" placeholder="Type a message or paste GIF URL..." />
      <button id="sendBtn">Send</button>
      <button id="gifBtn">GIF</button>
    </div>
  </div>

  <!-- ===================== -->
  <!-- Games Panel -->
  <!-- ===================== -->
  <div class="games-panel" id="gamesPanel">
    <div class="games-header">
      <h2>Games</h2>
      <input type="text" class="games-search" id="gameSearch" placeholder="Search games..." />
    </div>
    <div class="game-list" id="gameList">
      <!-- Example Game Card -->
      <div class="game-card">
        <div class="game-info">
          <h4>Fossil Clicker</h4>
          <p>Dig and collect fossils!</p>
        </div>
        <button class="open-game-btn" data-game="fossil">Play</button>
      </div>
      <!-- Add more game cards here -->
    </div>
  </div>

</div>

<!-- ===================== -->
<!-- Game Modal (Hidden by default) -->
<!-- ===================== -->
<div class="game-modal hidden" id="gameModal">
  <div class="game-modal-card">
    <div class="game-modal-header">
      <h3 id="gameTitle">Game</h3>
      <button class="close-game-btn" id="closeGameModal">×</button>
    </div>
    <div class="game-modal-body" id="gameContainer">
      <!-- Game will render here dynamically -->
      <div class="fossil-game hidden" id="fossilGame">
        <h3>Fossil Clicker</h3>
        <p id="fossilCounter">Fossils: 0</p>
        <button id="digBtn">Dig Fossil</button>
        <button id="upgradeClickPower">Upgrade Click Power</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="app.js"></script>

<script>
const chatContainer = document.getElementById("chatContainer");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");
const gifBtn = document.getElementById("gifBtn");

const gameSearch = document.getElementById("gameSearch");
const closeGames = document.getElementById("closeGames");
const gamesGrid = document.getElementById("gamesGrid");

let fossils = 0;
let clickPower = 1;
let mutedUsers = []; // store muted user UIDs locally

const fossilCounter = document.getElementById("fossilCounter");
const digBtn = document.getElementById("digBtn");
const upgradeBtn = document.getElementById("upgradeClickPower");

// ==============================
// Fossil Clicker Logic
// ==============================
function updateFossilDisplay() {
  fossilCounter.textContent = `Fossils: ${fossils}`;
}

digBtn.onclick = () => {
  fossils += clickPower;
  updateFossilDisplay();
};

upgradeBtn.onclick = () => {
  if (fossils >= 10) {
    fossils -= 10;
    clickPower++;
    updateFossilDisplay();
  } else {
    alert("Not enough fossils!");
  }
};

// ==============================
// Command Handler
// ==============================
function handleCommand(cmd) {
  const parts = cmd.slice(1).split(" "); // remove "/" and split
  const command = parts[0].toLowerCase();
  const arg = parts.slice(1).join(" ");

  switch (command) {
    case "mute":
      if (!arg) return alert("Please provide a username to mute.");
      muteUser(arg);
      break;
    case "ban":
      if (!arg) return alert("Please provide a username to ban.");
      banUser(arg);
      break;
    case "help":
      alert("Available commands:\n/mute username\n/ban username\n/help");
      break;
    default:
      alert("Unknown command: " + command);
  }
}

// ==============================
// Command Functions
// ==============================
function muteUser(username) {
  firebase.firestore().collection("users").where("displayName", "==", username)
    .get()
    .then(snapshot => {
      if (snapshot.empty) return alert("User not found.");
      snapshot.forEach(doc => {
        const uid = doc.id;
        if (!mutedUsers.includes(uid)) mutedUsers.push(uid);
        alert(username + " has been muted.");
      });
    });
}

function banUser(username) {
  firebase.firestore().collection("users").where("displayName", "==", username)
    .get()
    .then(snapshot => {
      if (snapshot.empty) return alert("User not found.");
      snapshot.forEach(doc => {
        doc.ref.update({ banned: true }).then(() => {
          alert(username + " has been banned.");
        });
      });
    });
}

// ==============================
// Firebase Chat
// ==============================
firebase.auth().onAuthStateChanged(currentUser => {
  if (!currentUser) {
    window.location.href = "login.html";
    return;
  }

  const uid = currentUser.uid;
  const serverId = "demoServer";

  const dbRef = firebase.firestore().collection("messages")
    .where("serverId", "==", serverId)
    .orderBy("createdAt");

  dbRef.onSnapshot(snapshot => {
    chatContainer.innerHTML = "";
    snapshot.forEach(doc => {
      const data = doc.data();
      
      if (mutedUsers.includes(data.uid)) return;

      const div = document.createElement("div");
      div.className = "chat-message " + (data.uid === uid ? "you" : "other");

      const name = document.createElement("strong");
      name.textContent = (data.uid === uid ? "You" : data.nickname || "Anonymous") + ": ";
      div.appendChild(name);

      if (data.type === "gif" && data.url) {
        const img = document.createElement("img");
        img.src = data.url;
        img.className = "chat-gif";
        div.appendChild(img);
      } else {
        div.appendChild(document.createTextNode(data.text));
      }

      chatContainer.appendChild(div);
    });
    chatContainer.scrollTop = chatContainer.scrollHeight;
  });

  // ==============================
  // Send Button
  // ==============================
  sendBtn.onclick = async () => {
    const input = chatInput.value.trim();
    if (!input) return;

    if (input.startsWith("/")) {
      handleCommand(input);
      chatInput.value = "";
      return;
    }

    const isGif = input.match(/\.gif(\?.*)?$/i);

    await firebase.firestore().collection("messages").add({
      type: isGif ? "gif" : "text",
      text: isGif ? null : input,
      url: isGif ? input : null,
      serverId,
      uid,
      nickname: currentUser.displayName || null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    chatInput.value = "";
  };

  gifBtn.onclick = () => {
    chatInput.value = "https://media.tenor.com/example.gif";
    chatInput.focus();
  };
});

// ==============================
// Games Section
// ==============================
gameSearch.oninput = () => {
  const filter = gameSearch.value.toLowerCase();
  const cards = gamesGrid.getElementsByClassName("game-card");
  Array.from(cards).forEach(card => {
    const name = card.querySelector("h3").textContent.toLowerCase();
    card.style.display = name.includes(filter) ? "flex" : "none";
  });
};

closeGames.onclick = () => {
  const section = document.querySelector(".games-section");
  section.style.display = section.style.display === "none" ? "block" : "none";
};

gamesGrid.addEventListener("click", e => {
  if (e.target.tagName === "BUTTON" && e.target.classList.contains("playBtn")) {
    const gameCard = e.target.closest(".game-card");
    const gameName = gameCard.querySelector("h3").textContent;

    if (gameName === "Fossil Clicker") {
      document.querySelector(".fossil-game").classList.remove("hidden");
    }
  }
});

document.querySelector(".fossil-game .close-game-btn")?.addEventListener("click", () => {
  document.querySelector(".fossil-game").classList.add("hidden");
});
</script>
</body>
</html>
