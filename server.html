<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Quickchat II — Server</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="style.css" />
</head>
<body>

<div class="server-header">
  <h1>Quickchat II — Server</h1>
  <p id="serverInfo">Server: Demo Server</p>
</div>

<div class="server-layout">

  <!-- CHAT SECTION -->
  <div class="chat-section">
    <div class="chat-container" id="chatContainer"></div>

    <div class="chat-input-container">
      <input type="text" id="chatInput" placeholder="Type a message or paste GIF URL..." />
      <button id="sendBtn">Send</button>
      <button id="gifBtn">GIF</button>
    </div>
  </div>

  <!-- GAMES PANEL -->
  <div class="games-panel">
    <div class="game-controls">
      <input type="text" class="game-search" id="gameSearch" placeholder="Search games..." />
      <button class="game-close-btn" id="toggleGames">Close</button>
    </div>
    <div class="games-grid" id="gamesGrid">
      <!-- Example Game Card -->
      <div class="game-card">
        <div class="game-info">
          <h3>Fossil Clicker</h3>
          <p>Dig and collect fossils!</p>
        </div>
        <button class="playBtn" data-game="fossil">Play</button>
      </div>
    </div>
  </div>
</div>

<!-- ACTIVE GAME CONTAINER (Hidden by default) -->
<div class="game-container hidden" id="activeGame">
  <div class="game-header">
    <h3 id="activeGameTitle">Game</h3>
    <button class="game-close-btn" id="closeActiveGame">Close</button>
  </div>
  <div class="game-body" id="activeGameBody">
    <!-- Fossil Clicker will be injected here -->
    <div class="fossil-game hidden" id="fossilGame">
      <h3>Fossil Clicker</h3>
      <p id="fossilCounter">Fossils: 0</p>
      <button id="digBtn">Dig Fossil</button>
      <button id="upgradeClickPower">Upgrade Click Power</button>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="app.js"></script>

<script>
const chatContainer = document.getElementById("chatContainer");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");
const gifBtn = document.getElementById("gifBtn");

const gameSearch = document.getElementById("gameSearch");
const toggleGamesBtn = document.getElementById("toggleGames");
const gamesGrid = document.getElementById("gamesGrid");

const activeGameContainer = document.getElementById("activeGame");
const activeGameTitle = document.getElementById("activeGameTitle");
const activeGameBody = document.getElementById("activeGameBody");
const closeActiveGame = document.getElementById("closeActiveGame");

const fossilGame = document.getElementById("fossilGame");
const fossilCounter = document.getElementById("fossilCounter");
const digBtn = document.getElementById("digBtn");
const upgradeBtn = document.getElementById("upgradeClickPower");

let fossils = 0;
let clickPower = 1;

/* ============================== */
/* Fossil Clicker Logic            */
/* ============================== */
function updateFossilDisplay() {
  fossilCounter.textContent = `Fossils: ${fossils}`;
}

digBtn.onclick = () => {
  fossils += clickPower;
  updateFossilDisplay();
};

upgradeBtn.onclick = () => {
  if(fossils >= 10) {
    fossils -= 10;
    clickPower++;
    updateFossilDisplay();
  } else {
    alert("Not enough fossils!");
  }
};

/* ============================== */
/* Firebase Chat                   */
/* ============================== */
firebase.auth().onAuthStateChanged(currentUser => {
  if(!currentUser) {
    window.location.href = "login.html";
    return;
  }

  const uid = currentUser.uid;
  const serverId = "demoServer";

  const dbRef = firebase.firestore().collection("messages")
    .where("serverId", "==", serverId)
    .orderBy("createdAt");

  dbRef.onSnapshot(snapshot => {
    chatContainer.innerHTML = "";
    snapshot.forEach(doc => {
      const data = doc.data();
      const div = document.createElement("div");
      div.className = "chat-message " + (data.uid === uid ? "you" : "other");

      const name = document.createElement("strong");
      name.textContent = (data.uid === uid ? "You" : data.nickname || "Anonymous") + ": ";
      div.appendChild(name);

      if(data.type === "gif" && data.url) {
        const img = document.createElement("img");
        img.src = data.url;
        img.className = "chat-gif";
        div.appendChild(img);
      } else {
        div.appendChild(document.createTextNode(data.text));
      }

      chatContainer.appendChild(div);
    });
    chatContainer.scrollTop = chatContainer.scrollHeight;
  });

  sendBtn.onclick = async () => {
    const input = chatInput.value.trim();
    if(!input) return;

    const isGif = input.match(/\.gif(\?.*)?$/i);

    await firebase.firestore().collection("messages").add({
      type: isGif ? "gif" : "text",
      text: isGif ? null : input,
      url: isGif ? input : null,
      serverId,
      uid,
      nickname: currentUser.displayName || null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    chatInput.value = "";
  };

  gifBtn.onclick = () => {
    chatInput.value = "https://media.tenor.com/example.gif";
    chatInput.focus();
  };
});

/* ============================== */
/* Games Search + Toggle           */
/* ============================== */
gameSearch.oninput = () => {
  const filter = gameSearch.value.toLowerCase();
  const cards = gamesGrid.getElementsByClassName("game-card");
  Array.from(cards).forEach(card => {
    const name = card.querySelector("h3").textContent.toLowerCase();
    card.style.display = name.includes(filter) ? "flex" : "none";
  });
};

toggleGamesBtn.onclick = () => {
  const panel = document.querySelector(".games-panel");
  panel.style.display = panel.style.display === "none" ? "flex" : "none";
};

/* ============================== */
/* Play Game Buttons               */
/* ============================== */
document.querySelectorAll(".playBtn").forEach(btn => {
  btn.onclick = () => {
    const game = btn.dataset.game;
    activeGameContainer.classList.remove("hidden");
    if(game === "fossil") {
      activeGameTitle.textContent = "Fossil Clicker";
      fossilGame.classList.remove("hidden");
    }
  };
});

closeActiveGame.onclick = () => {
  activeGameContainer.classList.add("hidden");
  fossilGame.classList.add("hidden");
};
</script>

</body>
</html>
