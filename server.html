<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Quickchat II — Server</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">
<style>
  body {
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
    background: #0f172a;
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
  }

  .server-header {
    margin-top: 20px;
    text-align: center;
  }

  /* Chat */
  .chat-container {
    width: 90%;
    max-width: 600px;
    flex: 1;
    display: flex;
    flex-direction: column;
    border: 1px solid #444;
    border-radius: 8px;
    padding: 10px;
    background-color: #020617;
    margin-top: 20px;
    overflow-y: auto;
  }

  .chat-message {
    margin-bottom: 6px;
    padding: 4px 8px;
    border-radius: 6px;
    background-color: #111827;
    word-wrap: break-word;
    display: flex;
    flex-direction: column;
  }

  .chat-message strong {
    font-weight: 600;
    margin-bottom: 2px;
  }

  .chat-input-container {
    width: 90%;
    max-width: 600px;
    display: flex;
    gap: 8px;
    margin-top: 10px;
  }

  .chat-input-container input {
    flex: 1;
    padding: 10px;
    border-radius: 6px;
    border: none;
    font-size: 16px;
    background-color: #020617;
    color: white;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
  }

  .chat-input-container button {
    padding: 10px 16px;
    border-radius: 6px;
    border: none;
    background: #2563eb;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.12s ease;
  }

  .chat-input-container button:hover {
    background: #1d4ed8;
  }

  .chat-gif {
    max-width: 220px;
    border-radius: 12px;
    margin-top: 4px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.35);
  }

  /* Fossil Clicker */
  .fossil-game {
    margin-top: 20px;
    padding: 15px;
    background-color: #020617;
    border-radius: 12px;
    width: 300px;
    text-align: center;
    display: none; /* hidden initially */
  }

  .fossil-game button {
    margin-top: 8px;
    width: 100%;
    border-radius: 8px;
    border: none;
    padding: 10px;
    background: #2563eb;
    color: white;
    font-weight: 600;
    cursor: pointer;
  }

  .fossil-game button:hover {
    background: #1d4ed8;
  }

  /* Games Section */
  .games-section {
    width: 90%;
    max-width: 900px;
    margin: 20px auto;
  }

  .game-controls {
    display: flex;
    gap: 12px;
    margin-bottom: 18px;
  }

  .game-search {
    flex: 1;
    padding: 12px 14px;
    border-radius: 10px;
    border: none;
    background: #020617;
    color: white;
    font-size: 14px;
    outline: none;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
  }

  .game-close-btn {
    padding: 12px 16px;
    border-radius: 10px;
    border: none;
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    color: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
  }

  .games-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 16px;
  }

  .game-card {
    background: #020617;
    border-radius: 14px;
    padding: 16px;
    box-shadow: 0 10px 24px rgba(0,0,0,0.45);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    border: 1px solid rgba(255,255,255,0.05);
  }

  .game-card h3 {
    margin: 0 0 6px 0;
    font-size: 16px;
    font-weight: 600;
  }

  .game-card p {
    margin: 0 0 14px 0;
    font-size: 13px;
    opacity: 0.75;
  }

  .game-card button {
    width: 100%;
    padding: 10px;
    border-radius: 10px;
    border: none;
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    color: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
  }

  .game-card button:hover {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
  }
</style>
</head>
<body>

<div class="server-header">
  <h1>Quickchat II — Server</h1>
  <p id="serverInfo">Server: Demo Server</p>
</div>

<div class="chat-container" id="chatContainer"></div>

<div class="chat-input-container">
  <input type="text" id="chatInput" placeholder="Type a message or paste GIF URL...">
  <button id="sendBtn">Send</button>
  <button id="gifBtn">GIF</button>
</div>

<!-- Fossil Clicker hidden initially -->
<div class="fossil-game" id="fossilGame">
  <h3>Fossil Clicker</h3>
  <p id="fossilCounter">Fossils: 0</p>
  <button id="digBtn">Dig Fossil</button>
  <button id="upgradeClickPower">Upgrade Click Power</button>
</div>

<div class="games-section">
  <div class="game-controls">
    <input type="text" class="game-search" id="gameSearch" placeholder="Search games...">
    <button class="game-close-btn" id="closeGames">Toggle Games</button>
  </div>
  <div class="games-grid" id="gamesGrid">
    <div class="game-card">
      <h3>Fossil Clicker</h3>
      <p>Dig and collect fossils!</p>
      <button class="playBtn">Play</button>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="app.js"></script>

<script>
const chatContainer = document.getElementById("chatContainer");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");
const gifBtn = document.getElementById("gifBtn");

let fossils = 0;
let clickPower = 1;

const fossilCounter = document.getElementById("fossilCounter");
const digBtn = document.getElementById("digBtn");
const upgradeBtn = document.getElementById("upgradeClickPower");
const fossilGame = document.getElementById("fossilGame");

// ==============================
// Fossil Clicker Logic
// ==============================
function updateFossilDisplay() {
  fossilCounter.textContent = `Fossils: ${fossils}`;
}

digBtn.onclick = () => {
  fossils += clickPower;
  updateFossilDisplay();
};

upgradeBtn.onclick = () => {
  if(fossils >= 10) {
    fossils -= 10;
    clickPower++;
    updateFossilDisplay();
  } else {
    alert("Not enough fossils!");
  }
};

// ==============================
// Firebase Chat
// ==============================
firebase.auth().onAuthStateChanged(currentUser => {
  if(!currentUser) {
    window.location.href = "login.html";
    return;
  }

  const uid = currentUser.uid;
  const serverId = "demoServer"; 

  const dbRef = firebase.firestore().collection("messages")
    .where("serverId", "==", serverId)
    .orderBy("createdAt");

  dbRef.onSnapshot(snapshot => {
    chatContainer.innerHTML = "";
    snapshot.forEach(doc => {
      const data = doc.data();
      const div = document.createElement("div");
      div.className = "chat-message";

      const name = document.createElement("strong");
      name.textContent = (data.uid === uid ? "You" : data.nickname || "Anonymous") + ": ";
      div.appendChild(name);

      if(data.type === "gif" && data.url) {
        const img = document.createElement("img");
        img.src = data.url;
        img.className = "chat-gif";
        div.appendChild(img);
      } else {
        div.appendChild(document.createTextNode(data.text));
      }

      chatContainer.appendChild(div);
    });
    chatContainer.scrollTop = chatContainer.scrollHeight;
  });

  sendBtn.onclick = async () => {
    const input = chatInput.value.trim();
    if(!input) return;

    const isGif = input.match(/\.gif(\?.*)?$/i);

    await firebase.firestore().collection("messages").add({
      type: isGif ? "gif" : "text",
      text: isGif ? null : input,
      url: isGif ? input : null,
      serverId,
      uid,
      nickname: currentUser.displayName || null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    chatInput.value = "";
  };

  gifBtn.onclick = () => {
    chatInput.value = "https://media.tenor.com/example.gif";
    chatInput.focus();
  };
});

// ==============================
// Games Search + Toggle
// ==============================
const gameSearch = document.getElementById("gameSearch");
const closeGames = document.getElementById("closeGames");
const gamesGrid = document.getElementById("gamesGrid");

gameSearch.oninput = () => {
  const filter = gameSearch.value.toLowerCase();
  const cards = gamesGrid.getElementsByClassName("game-card");
  Array.from(cards).forEach(card => {
    const name = card.querySelector("h3").textContent.toLowerCase();
    card.style.display = name.includes(filter) ? "flex" : "none";
  });
};

closeGames.onclick = () => {
  const gamesSection = document.querySelector(".games-section");
  gamesSection.style.display = gamesSection.style.display === "none" ? "block" : "none";
};

// ==============================
// Play buttons (Fossil Clicker toggle)
// ==============================
const fossilPlayBtn = document.querySelector(".game-card button.playBtn");
fossilPlayBtn.onclick = () => {
  fossilGame.style.display = fossilGame.style.display === "none" ? "block" : "none";
};
</script>

</body>
</html>
