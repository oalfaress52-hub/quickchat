<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quickchat II — Server</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="server-header">
    <h1>Quickchat II</h1>
    <p id="serverInfo">Demo Server</p>
  </header>

  <main class="server-layout">
    <!-- CHAT -->
    <section class="chat-section">
      <div class="chat-container" id="chatContainer"></div>

      <div class="chat-input-container">
        <input type="text" id="chatInput" placeholder="Type your message..." />
        <button id="sendBtn">Send</button>
      </div>
    </section>

    <!-- GAMES PANEL -->
    <aside class="games-panel">
      <div class="games-header">
        <h2>Games</h2>
        <input type="text" id="gameSearch" placeholder="Search games..." />
      </div>

      <div class="games-list" id="gamesList">
        <div class="game-card" data-game="fossil">
          <div class="game-info">
            <h3>Fossil Clicker</h3>
            <p>Click to collect fossils and upgrade your power.</p>
          </div>
          <button class="open-game-btn">Play</button>
        </div>
      </div>
    </aside>
  </main>

  <!-- GAME MODAL -->
  <div class="game-modal hidden" id="gameModal">
    <div class="game-modal-card">
      <div class="game-modal-header">
        <h3 id="gameTitle">Fossil Clicker</h3>
        <button class="close-game-btn" id="closeGameBtn">✕</button>
      </div>

      <div class="game-modal-body" id="gameContent">
        <!-- Fossil game injects here -->
        <div class="fossil-game">
          <p id="fossilCounter">Fossils: 0</p>
          <button id="digBtn">Dig Fossil</button>
          <button id="upgradeClickPower">Upgrade Click Power</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- App logic -->
  <script src="app.js"></script>

  <script>
    const chatContainer = document.getElementById("chatContainer");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");

    const gameModal = document.getElementById("gameModal");
    const closeGameBtn = document.getElementById("closeGameBtn");
    const gameSearch = document.getElementById("gameSearch");
    const gamesList = document.getElementById("gamesList");

    firebase.auth().onAuthStateChanged(currentUser => {
      if (!currentUser) {
        window.location.href = "login.html";
        return;
      }

      const uid = currentUser.uid;
      const serverId = "demoServer";

      const dbRef = firebase.firestore()
        .collection("messages")
        .where("serverId", "==", serverId)
        .orderBy("createdAt");

      dbRef.onSnapshot(snapshot => {
        chatContainer.innerHTML = "";
        snapshot.forEach(doc => {
          const msg = doc.data();
          const div = document.createElement("div");
          div.className = "chat-message";
          const displayName = msg.uid === uid ? "You" : msg.nickname || "Anonymous";
          div.textContent = `${displayName}: ${msg.text}`;
          chatContainer.appendChild(div);
        });
        chatContainer.scrollTop = chatContainer.scrollHeight;
      });

      sendBtn.onclick = async () => {
        const text = chatInput.value.trim();
        if (!text) return;

        await firebase.firestore().collection("messages").add({
          text,
          serverId,
          uid,
          nickname: currentUser.displayName || null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        chatInput.value = "";
      };
    });

    // =========================
    // GAME SYSTEM
    // =========================
    const fossilGame = {
      fossils: 0,
      clickPower: 1,
      init() {
        this.fossils = 0;
        this.clickPower = 1;
        updateFossilDisplay();
      }
    };

    const fossilCounter = document.getElementById("fossilCounter");
    const digBtn = document.getElementById("digBtn");
    const upgradeBtn = document.getElementById("upgradeClickPower");

    function updateFossilDisplay() {
      fossilCounter.textContent = `Fossils: ${fossilGame.fossils}`;
    }

    digBtn.onclick = () => {
      fossilGame.fossils += fossilGame.clickPower;
      updateFossilDisplay();
    };

    upgradeBtn.onclick = () => {
      if (fossilGame.fossils >= 10) {
        fossilGame.fossils -= 10;
        fossilGame.clickPower++;
        updateFossilDisplay();
      }
    };

    document.querySelectorAll(".open-game-btn").forEach(btn => {
      btn.onclick = () => {
        gameModal.classList.remove("hidden");
        fossilGame.init();
      };
    });

    closeGameBtn.onclick = () => {
      gameModal.classList.add("hidden");
    };

    // =========================
    // GAME SEARCH
    // =========================
    gameSearch.addEventListener("input", () => {
      const query = gameSearch.value.toLowerCase();
      document.querySelectorAll(".game-card").forEach(card => {
        const title = card.querySelector("h3").textContent.toLowerCase();
        card.style.display = title.includes(query) ? "flex" : "none";
      });
    });
  </script>
</body>
</html>
