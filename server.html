<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Quickchat II — Server</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="style.css" />
</head>
<body>

<div class="server-header">
  <h1>Quickchat II — Server</h1>
  <p id="serverInfo">Server: Demo Server</p>
</div>

<div class="server-layout">

  <!-- ===================== -->
  <!-- Chat Section -->
  <!-- ===================== -->
  <div class="chat-section">
    <div class="chat-container" id="chatContainer"></div>

    <div class="chat-input-container">
      <input type="text" id="chatInput" placeholder="Type a message or paste GIF URL..." />
      <button id="sendBtn">Send</button>
      <button id="gifBtn">GIF</button>
    </div>
  </div>

  <!-- ===================== -->
  <!-- Games Panel -->
  <!-- ===================== -->
  <div class="games-panel" id="gamesPanel">
    <div class="games-header">
      <h2>Games</h2>
      <input type="text" class="games-search" id="gameSearch" placeholder="Search games..." />
    </div>
    <div class="game-list" id="gameList">
      <!-- Example Game Card -->
      <div class="game-card">
        <div class="game-info">
          <h4>Fossil Clicker</h4>
          <p>Dig and collect fossils!</p>
        </div>
        <button class="open-game-btn" data-game="fossil">Play</button>
      </div>
      <!-- Add more game cards here -->
    </div>
  </div>

</div>

<!-- ===================== -->
<!-- Game Modal (Hidden by default) -->
<!-- ===================== -->
<div class="game-modal hidden" id="gameModal">
  <div class="game-modal-card">
    <div class="game-modal-header">
      <h3 id="gameTitle">Game</h3>
      <button class="close-game-btn" id="closeGameModal">×</button>
    </div>
    <div class="game-modal-body" id="gameContainer">
      <!-- Game will render here dynamically -->
      <div class="fossil-game hidden" id="fossilGame">
        <h3>Fossil Clicker</h3>
        <p id="fossilCounter">Fossils: 0</p>
        <button id="digBtn">Dig Fossil</button>
        <button id="upgradeClickPower">Upgrade Click Power</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="app.js"></script>

<script>
const chatContainer = document.getElementById("chatContainer");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");
const gifBtn = document.getElementById("gifBtn");

const gameSearch = document.getElementById("gameSearch");
const gameList = document.getElementById("gameList");
const gameModal = document.getElementById("gameModal");
const gameContainer = document.getElementById("gameContainer");
const closeGameModal = document.getElementById("closeGameModal");

const fossilGame = document.getElementById("fossilGame");
const fossilCounter = document.getElementById("fossilCounter");
const digBtn = document.getElementById("digBtn");
const upgradeBtn = document.getElementById("upgradeClickPower");

let fossils = 0;
let clickPower = 1;

// ==============================
// Fossil Clicker Logic
// ==============================
function updateFossilDisplay() {
  fossilCounter.textContent = `Fossils: ${fossils}`;
}

digBtn.onclick = () => {
  fossils += clickPower;
  updateFossilDisplay();
};

upgradeBtn.onclick = () => {
  if(fossils >= 10) {
    fossils -= 10;
    clickPower++;
    updateFossilDisplay();
  } else {
    alert("Not enough fossils!");
  }
};

// ==============================
// Firebase Chat
// ==============================
firebase.auth().onAuthStateChanged(currentUser => {
  if(!currentUser) {
    window.location.href = "login.html";
    return;
  }

  const uid = currentUser.uid;
  const serverId = "demoServer";

  const dbRef = firebase.firestore().collection("messages")
    .where("serverId", "==", serverId)
    .orderBy("createdAt");

  dbRef.onSnapshot(snapshot => {
    chatContainer.innerHTML = "";
    snapshot.forEach(doc => {
      const data = doc.data();
      const div = document.createElement("div");
      div.className = "chat-message " + (data.uid === uid ? "you" : "other");

      const name = document.createElement("strong");
      name.textContent = (data.uid === uid ? "You" : data.nickname || "Anonymous") + ": ";
      div.appendChild(name);

      if(data.type === "gif" && data.url) {
        const img = document.createElement("img");
        img.src = data.url;
        img.className = "chat-gif";
        div.appendChild(img);
      } else {
        div.appendChild(document.createTextNode(data.text));
      }

      chatContainer.appendChild(div);
    });
    chatContainer.scrollTop = chatContainer.scrollHeight;
  });

  sendBtn.onclick = async () => {
    const input = chatInput.value.trim();
    if(!input) return;

    const isGif = input.match(/\.gif(\?.*)?$/i);

    await firebase.firestore().collection("messages").add({
      type: isGif ? "gif" : "text",
      text: isGif ? null : input,
      url: isGif ? input : null,
      serverId,
      uid,
      nickname: currentUser.displayName || null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    chatInput.value = "";
  };

  gifBtn.onclick = () => {
    chatInput.value = "https://media.tenor.com/example.gif";
    chatInput.focus();
  };
});

// ==============================
// Game Search
// ==============================
gameSearch.oninput = () => {
  const filter = gameSearch.value.toLowerCase();
  Array.from(gameList.getElementsByClassName("game-card")).forEach(card => {
    const name = card.querySelector("h4").textContent.toLowerCase();
    card.style.display = name.includes(filter) ? "flex" : "none";
  });
};

// ==============================
// Open Game Modal
// ==============================
document.querySelectorAll(".open-game-btn").forEach(btn => {
  btn.onclick = () => {
    const game = btn.dataset.game;
    gameModal.classList.remove("hidden");
    // Render Fossil Clicker only
    if(game === "fossil") {
      fossilGame.classList.remove("hidden");
    } else {
      fossilGame.classList.add("hidden");
    }
  };
});

// ==============================
// Close Game Modal
// ==============================
closeGameModal.onclick = () => {
  gameModal.classList.add("hidden");
  fossilGame.classList.add("hidden");
};
</script>

</body>
</html>
