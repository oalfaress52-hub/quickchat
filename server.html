<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Quickchat II — Server</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="server-page">

    <div class="server-header">
      <h1>Quickchat II — Server</h1>
      <p id="serverInfo">Server: Demo Server</p>
    </div>

    <!-- CHAT FLEX COLUMN -->
    <div class="chat-wrapper">
      <div class="chat-container" id="chatContainer"></div>

      <div class="chat-input-container">
        <input type="text" id="chatInput" placeholder="Type your message..." />
        <button id="sendBtn">Send</button>
      </div>
    </div>

    <!-- GAMES PANEL -->
    <div class="games-wrapper">
      <input type="text" id="gameSearch" class="game-search" placeholder="Search games..." />
      <div id="gamesList" class="games-list"></div>
      <div id="gameContainer" class="game-container hidden"></div>
    </div>

  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- App logic -->
  <script src="app.js"></script>

  <script>
    const chatContainer = document.getElementById("chatContainer");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");
    const gamesList = document.getElementById("gamesList");
    const gameSearch = document.getElementById("gameSearch");
    const gameContainer = document.getElementById("gameContainer");

    firebase.auth().onAuthStateChanged(currentUser => {
      if (!currentUser) {
        window.location.href = "login.html";
        return;
      }

      const uid = currentUser.uid;
      const serverId = "demoServer";

      const dbRef = firebase.firestore()
        .collection("messages")
        .where("serverId", "==", serverId)
        .orderBy("createdAt");

      // ===============================
      // CHAT LISTENER
      // ===============================
      dbRef.onSnapshot(snapshot => {
        chatContainer.innerHTML = "";
        snapshot.forEach(doc => {
          const msg = doc.data();
          const div = document.createElement("div");
          div.className = "chat-message" + (msg.uid === uid ? " you" : "");
          const name = msg.uid === uid ? "You" : msg.nickname || "Anonymous";
          div.textContent = `${name}: ${msg.text}`;
          chatContainer.appendChild(div);
        });
        chatContainer.scrollTop = chatContainer.scrollHeight;
      });

      // ===============================
      // SEND MESSAGE
      // ===============================
      sendBtn.onclick = async () => {
        const text = chatInput.value.trim();
        if (!text) return;

        try {
          await firebase.firestore().collection("messages").add({
            text,
            serverId,
            uid,
            nickname: currentUser.displayName || null,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          chatInput.value = "";
        } catch (err) {
          console.error("Message send failed:", err);
        }
      };

      // ===============================
      // GAMES SYSTEM
      // ===============================
      const games = [
        { id: "fossil", name: "Fossil Clicker" }
      ];

      function renderGames(filter = "") {
        gamesList.innerHTML = "";
        games
          .filter(g => g.name.toLowerCase().includes(filter.toLowerCase()))
          .forEach(game => {
            const btn = document.createElement("div");
            btn.className = "game-item";
            btn.textContent = game.name;
            btn.onclick = () => launchGame(game.id);
            gamesList.appendChild(btn);
          });
      }

      gameSearch.oninput = () => {
        renderGames(gameSearch.value);
      };

      function launchGame(gameId) {
        gameContainer.classList.remove("hidden");
        gameContainer.innerHTML = "";

        const header = document.createElement("div");
        header.className = "game-header";

        const title = document.createElement("h3");
        title.textContent = "Fossil Clicker";

        const closeBtn = document.createElement("button");
        closeBtn.className = "close-game-btn";
        closeBtn.textContent = "Close";
        closeBtn.onclick = closeGame;

        header.appendChild(title);
        header.appendChild(closeBtn);
        gameContainer.appendChild(header);

        if (gameId === "fossil") {
          loadFossilClicker();
        }
      }

      function closeGame() {
        gameContainer.classList.add("hidden");
        gameContainer.innerHTML = "";
      }

      function loadFossilClicker() {
        const gameDiv = document.createElement("div");
        gameDiv.className = "fossil-game";
        gameDiv.innerHTML = `
          <p id="fossilCounter">Fossils: 0</p>
          <button id="digBtn">Dig Fossil</button>
          <button id="upgradeClickPower">Upgrade Click Power</button>
        `;
        gameContainer.appendChild(gameDiv);

        let fossils = 0;
        let clickPower = 1;

        const fossilCounter = document.getElementById("fossilCounter");
        const digBtn = document.getElementById("digBtn");
        const upgradeBtn = document.getElementById("upgradeClickPower");

        function updateFossilDisplay() {
          fossilCounter.textContent = `Fossils: ${fossils}`;
        }

        digBtn.onclick = () => {
          fossils += clickPower;
          updateFossilDisplay();
        };

        upgradeBtn.onclick = () => {
          if (fossils >= 10) {
            fossils -= 10;
            clickPower++;
            updateFossilDisplay();
          } else {
            alert("Not enough fossils!");
          }
        };
      }

      renderGames();
    });
  </script>
</body>
</html>
