<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quickchat - Home</title>
  <link rel="stylesheet" href="style.css">
  <script type="module" src="firebase.js"></script>
  <script type="module" src="app.js"></script>
</head>
<body>
  <h1>Quickchat Home</h1>

  <p>Logged in as: <span id="userEmail"></span></p>
  <button id="logoutBtn">Logout</button>

  <hr>

  <!-- Create Server -->
  <h2>Create a New Server</h2>
  <input type="text" id="newServerName" placeholder="Server Name">
  <button id="createServerBtn">Create Server</button>

  <hr>

  <!-- Join Existing Server -->
  <h2>Available Servers</h2>
  <ul id="serverList"></ul>

  <script type="module">
    import { auth } from './firebase.js';
    import { signOut, onAuthStateChanged } from "firebase/auth";
    import { db } from './firebase.js';
    import { collection, getDocs, addDoc, updateDoc, doc, arrayUnion } from "firebase/firestore";

    let currentUser;

    onAuthStateChanged(auth, user => {
      if (!user) return window.location.href = "login.html";
      currentUser = user;
      document.getElementById("userEmail").textContent = user.email;

      // Load servers
      loadServers();
    });

    document.getElementById("logoutBtn").onclick = () => {
      signOut(auth).then(() => window.location.href = "login.html");
    };

    // ----------------------------
    // CREATE SERVER
    // ----------------------------
    document.getElementById("createServerBtn").onclick = async () => {
      const name = document.getElementById("newServerName").value.trim();
      if (!name) return alert("Please enter a server name");

      const serverRef = await addDoc(collection(db, "servers"), {
        name,
        owners: [currentUser.uid],
        moderators: [],
        members: [currentUser.uid],
        createdAt: new Date()
      });

      window.location.href = `server.html?serverId=${serverRef.id}`;
    };

    // ----------------------------
    // LOAD SERVERS
    // ----------------------------
    async function loadServers() {
      const list = document.getElementById("serverList");
      list.innerHTML = "";

      const querySnap = await getDocs(collection(db, "servers"));
      querySnap.forEach(docSnap => {
        const server = { id: docSnap.id, ...docSnap.data() };
        const li = document.createElement("li");
        const joinBtn = document.createElement("button");
        joinBtn.textContent = "Join / Open";
        joinBtn.onclick = async () => {
          const serverRef = doc(db, "servers", server.id);
          await updateDoc(serverRef, {
            members: arrayUnion(currentUser.uid)
          });
          window.location.href = `server.html?serverId=${server.id}`;
        };
        li.textContent = server.name + " ";
        li.appendChild(joinBtn);
        list.appendChild(li);
      });
    }
  </script>
</body>
</html>
